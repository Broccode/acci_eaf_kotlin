# 15. Security Best Practices
>
> This document is a granulated shard from the main "ACCI-EAF-Architecture.md" focusing on "Security Best Practices".

Security is a paramount concern for the ACCI EAF and applications built upon it. The following best practices are mandatory and must be actively addressed by all developers (human and AI agents) throughout the development lifecycle. These practices aim to mitigate common vulnerabilities (including those listed in OWASP Top 10) and ensure compliance with relevant NFRs.

* **Input Sanitization and Validation (OWASP A03:2021-Injection):**
  * **API Input Validation:** All data received from external sources (API request payloads, query parameters, headers) by any EAF API (e.g., `eaf-controlplane-api`, `eaf-license-server`) must be rigorously validated at the boundary before processing.
    * Utilize Spring Validation API (Bean Validation with JSR 303/380 annotations like `@Valid`, `@NotNull`, `@NotEmpty`, `@Size`, `@Pattern`, custom validators) on DTOs in `@RestController` methods.
    * Validation should cover data types, formats, lengths, ranges, and allowed character sets.
  * **Contextual Escaping/Encoding for Other Inputs:** Data from less direct sources (e.g., configuration files, database, messages from other internal systems) that might be used in potentially risky operations (like constructing log messages, queries, or file paths) should be handled with care, using appropriate escaping or encoding if they are ever reflected in outputs or used in sensitive sinks.
  * **Preventing Log Injection:** When logging user-supplied or external data, ensure it is properly handled by the structured logging framework to prevent log forging or injection of malicious characters (e.g., CRLF injection). Parameterized logging helps significantly.

* **Output Encoding (OWASP A03:2021-Injection, specifically XSS):**
  * **JSON APIs:** For REST APIs like `eaf-controlplane-api` and `eaf-license-server` that return JSON, Spring Boot with Jackson automatically handles proper JSON encoding, which mitigates XSS vulnerabilities within a JSON context. Ensure content types are correctly set to `application/json`.
  * **Control Plane UI (React):** The React-based Control Plane UI is responsible for its own XSS prevention. This includes:
    * Leveraging React\'s default JSX string encoding.
    * Avoiding direct use of `dangerouslySetInnerHTML` with un-sanitized user-supplied content.
    * Using appropriate, vetted libraries for rendering complex content like Markdown if it can originate from users.
  * **Data to UI:** While the backend API provides JSON, any data originating from user input that is sent back to a UI should still be treated by the UI as potentially untrusted and handled with appropriate output encoding or sanitization mechanisms within the UI framework.

* **Secrets Management:**
  * **No Hardcoded Secrets:** Secrets (passwords, API keys, client secrets, encryption keys, database credentials) must **never** be hardcoded in source code, committed to version control, or included in build artifacts.
  * **Externalized Configuration:** Secrets must be managed externally and supplied to the application at runtime via Spring Boot\'s externalized configuration mechanisms. For Docker Compose deployments on customer VMs, this typically means:
    * Using an `.env` file (kept outside version control and secured on the VM) that Docker Compose injects as environment variables into the containers.
    * Mounting secret files directly into containers (e.g., via Docker Compose `secrets` or volume mounts) and configuring Spring Boot to read them.
  * **Logging:** Ensure secrets are never logged. Configure log masking for known secret patterns if necessary, though avoiding logging them in the first place is paramount.
  * **`eaf-iam` Client Secrets:** Client secrets for service accounts generated by `eaf-iam` must be handled securely, returned only upon creation, and stored hashed within the EAF.

* **Dependency Security & Software Bill of Materials (SBOM):**
  * **Vulnerability Scanning:** Implement automated dependency vulnerability scanning using tools like the **OWASP Dependency-Check Gradle plugin**. This scan must be integrated into the CI/CD pipeline and configured to fail the build if critical or high-severity vulnerabilities are detected in project dependencies or their transitive dependencies.
  * **Regular Updates:** Regularly review and update dependencies to their latest secure versions, following the policy defined in "Dependency Management".
  * **SBOM Generation & Review (PRD NFR 9):**
    * Automatically generate an SBOM (Software Bill of Materials) in a standard format (e.g., CycloneDX, SPDX) for every EAF release and for applications built upon it. This will be part of the CI/CD pipeline.
    * Establish a process for continuously reviewing these SBOMs for license compliance and newly discovered vulnerabilities in third-party components (e.g., using OWASP Dependency Track or similar tools).

* **Authentication and Authorization Checks (via `eaf-iam`):**
  * **Enforce Authentication:** All API endpoints (except potentially a few explicitly public ones like health checks, if any) must enforce robust authentication using mechanisms provided or integrated by `eaf-iam` (e.g., token-based for API clients, OIDC/SAML for users via Control Plane UI). This will be integrated via Spring Security.
  * **Enforce Authorization:** Authorization (permission/role-based access control - RBAC) based on definitions within `eaf-iam` must be enforced for all protected resources and operations. This should occur at the service layer or API entry points, utilizing Spring Security\'s method security (`@PreAuthorize`, `@PostAuthorize`) or fine-grained checks within business logic where appropriate.

* **Principle of Least Privilege:**
  * **Database Users:** The PostgreSQL user account(s) utilized by the ACCI EAF applications (e.g., `eaf-controlplane-api`, `eaf-license-server`, Axon Event Store user) must be granted only the minimum necessary DML/DDL permissions (SELECT, INSERT, UPDATE, DELETE on specific tables/schemas) required for their operation. Avoid using PostgreSQL superuser accounts for application runtime.
  * **OS Service Accounts (Docker Context):** Docker containers should be configured to run with non-root users where possible. Define specific users within Dockerfiles.
  * **Application Permissions:** Within the application logic, components should only have access to the data and operations necessary for their specific function.

* **API Security (General):**
  * **HTTPS Exclusively:** All external API communication (to and from `eaf-controlplane-api`, `eaf-license-server`) must be over HTTPS. SSL/TLS termination can be handled by a reverse proxy (e.g., Nginx/Traefik container within the Docker Compose stack) or configured directly in Spring Boot (less common for edge traffic but possible).
  * **Rate Limiting & Throttling:** Implement rate limiting on all public-facing API endpoints to protect against Denial-of-Service (DoS) attacks and API abuse. This can be implemented using libraries like Resilience4j (`RateLimiter`) within Spring Boot applications or via a reverse proxy.
  * **HTTP Security Headers:** Configure appropriate HTTP security headers to be returned by API responses to enhance browser security for the Control Plane UI. These include:
    * `Strict-Transport-Security (HSTS)`
    * `X-Content-Type-Options: nosniff`
    * `X-Frame-Options: DENY` (or `SAMEORIGIN`)
    * `Content-Security-Policy (CSP)` (can be complex but highly effective)
    * `X-XSS-Protection` (though largely superseded by CSP)
        These can be configured in Spring Security or the reverse proxy.
  * **Input Validation:** (Reiterated) Crucial for preventing injection attacks and ensuring data integrity.

* **Error Handling & Information Disclosure:**
  * As defined in the "Error Handling Strategy": Ensure that error messages returned to API clients or displayed in UIs do **not** leak sensitive internal system information (e.g., stack traces, detailed SQL error messages, internal file paths, library versions).
  * Log detailed technical errors server-side for diagnostics. Provide generic, user-friendly error messages or correlation IDs to the client.

* **Regular Security Audits & Testing (PRD NFR 2f):**
  * **Internal Code Reviews:** Security considerations must be a part of regular code reviews.
  * **Penetration Testing:** Plan for and conduct external penetration tests on the EAF and critical EAF-based applications before significant production deployments or major releases.
  * **SAST/DAST:** Consider integrating Static Application Security Testing (SAST) tools into the CI/CD pipeline. Dynamic Application Security Testing (DAST) can be performed on running applications in test environments.

* **Other Relevant Security Practices:**
  * **Data Encryption:**
    * **In Transit:** HTTPS is mandatory for external communication. Communication between containers within the Docker Compose stack on the same host (e.g., API to Database) may use the Docker network; if this network is not considered fully trusted or if compliance requires it, inter-service TLS should be considered.
    * **At Rest:**
      * Sensitive configuration data (e.g., secrets in `.env` files on the VM) must be protected by appropriate VM host security and file permissions (customer responsibility).
      * For data stored in PostgreSQL (e.g., hashed passwords in `eaf-iam`, sensitive audit log entries), consider options like PostgreSQL\'s Transparent Data Encryption (TDE) via extensions (e.g., `pgcrypto` for column-level encryption if needed, though this adds complexity) or rely on filesystem-level encryption on the VM host (customer responsibility).
    * **FIPS 140-2/3 Compliance (PRD NFR 2c):** All cryptographic operations (password hashing, JWT signing/validation, TLS configuration, etc.) must be performed using libraries and JVM configurations that support or utilize FIPS 140-2/3 validated cryptographic modules. This involves careful selection and configuration of the JVM (e.g., IBM Semeru Runtimes in FIPS mode, or OpenJDK with a FIPS-certified provider like BouncyCastle-FIPS) and cryptographic libraries.
  * **Session Management (Control Plane UI):**
    * If traditional session cookies are used by the UI\'s authentication mechanism (though token-based via API is more likely with React), ensure they are configured securely: `HttpOnly`, `Secure` (if UI is HTTPS), `SameSite` attributes.
    * For token-based authentication (e.g., JWTs issued by `eaf-iam` and consumed by the UI), use short-lived access tokens and secure mechanisms for storing and refreshing tokens if refresh tokens are used.
  * **Audit Logging (`eaf-observability`):**
    * Ensure comprehensive and immutable audit logs capture all security-relevant events: successful/failed logins, logouts, significant administrative actions (tenant creation, user modification, role changes, license assignments), access to sensitive data, changes to security configurations.
    * Protect audit logs from unauthorized access and tampering. Ensure they include sufficient detail (timestamp, user, action, outcome, relevant resource IDs).
